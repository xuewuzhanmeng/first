<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width initial-scale=1"/>
    <title>百度新闻后端管理页</title>
    <link rel="stylesheet" type="text/css" href="./bootstrap-3.3.7-dist/css/bootstrap.css"/>
    <link rel='stylesheet' href='./stylesheets/admin.css'/>
    <!--处理ie9以下对h5标签的兼容性-->
    <!--处理ie9以下对响应式布局的兼容性-->
    <!--[if lt IE 9]>
    <script src="https://cdn.bootcss.com/html5shiv/3.7.3/html5shiv.min.js"></script>
    <script src="https://cdn.bootcss.com/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->
</head>
<body>
     <div class="container">
         <h1>百度新闻后台管理器</h1>
         <div class="row">
             <div class="col-lg-5 col-md-12">
                 <div class="left">
                     <h3>新闻发布器</h3>
                     <form>
                         <div class="form-group">
                             <label for="left_title">新闻标题</label>
                             <input type="text" class="form-control" id="left_title" placeholder="请输入新闻标题">
                         </div>
                         <div class="form-group">
                             <label for="left_content">新闻正文</label>
                             <textarea class="form-control" rows="5" id="left_content"></textarea>
                         </div>
                         <div class="form-group">
                             <label for="left_url">新闻图片地址</label>
                             <input type="text" class="form-control" id="left_url" placeholder="请输入新闻图片地址">
                         </div>
                         <div class="form-group">
                             <label for="left_conurl">新闻内容图片地址</label>
                             <input type="text" class="form-control" id="left_conurl" placeholder="请输入新闻内容图片地址">
                         </div>
                         <div class="form-group">
                             <label for="left_source">新闻来源</label>
                             <input type="text" class="form-control" id="left_source" placeholder="请输入新闻来源">
                         </div>
                         <div class="form-group">
                             <label for="left_date">新闻日期</label>
                             <input type="date" class="form-control" id="left_date" value="">
                         </div>
                         <div class="form-group">
                             <label for="left_type">新闻类型</label>
                             <select class="form-control" id="left_type">
                                 <option>精选</option>
                                 <option>百家</option>
                                 <option>本地</option>
                                 <option>娱乐</option>
                                 <option>社会</option>
                                 <option>军事</option>
                                 <option>女人</option>
                                 <option>搞笑</option>
                                 <option>互联网</option>
                                 <option>科技</option>
                                 <option>生活</option>
                                 <option>国际</option>
                                 <option>国内</option>
                                 <option>体育</option>
                                 <option>汽车</option>
                                 <option>财经</option>
                                 <option>房产</option>
                                 <option>时尚</option>
                                 <option>教育</option>
                                 <option>游戏</option>
                                 <option>旅游</option>
                                 <option>人文</option>
                                 <option>创意</option>
                             </select>
                         </div>
                         <button type="button" class="btn btn-primary btn3">提交</button>
                     </form>
                 </div>
             </div>
             <div class="col-lg-6 col-md-12 pull-right">
                 <div class="right">
                     <h3>新闻列表</h3>
                     <nav aria-label="Page navigation">
                         <ul class="pagination" id="split">



                         </ul>
                     </nav>
                     <table class="table">
                         <thead>
                         <tr>
                             <th class="col1">新闻编号</th>
                             <th class="col2">新闻标题</th>
                             <th class="col3">新闻时间</th>
                             <th class="col4">操作</th>
                         </tr>
                         </thead>
                         <tbody>

                         </tbody>

                     </table>
                 </div>

             </div>
         </div>




     </div>



    <script src="./bootstrap-3.3.7-dist/js/jquery.js"></script>
    <script src="./bootstrap-3.3.7-dist/js/bootstrap.js"></script>
     <script src="./javascripts/require.js" data-main="./javascripts/main"></script>
    <script>
        init(); //初始化
        //初始加载十条新闻列表
        $(function () {
//            $.ajax({
//                url:'/admin/getNewlist',
//                type:'post',
//                success:function (data) {
//                    $.each(data.list,function (index,element) {
//                        getnews(element);
//                    })
//                    //根据新闻数量动态添加li标签
//                    var n=data.n;
//                    for(var i=n;i>0;i--){
//                        $(".pre").after($("<li><a href='#' class='ye'>"+i+"</a></li>"));
//                    }
//                },
//                error:function (err) {
//                    console.log(err);
//                }
//            })
//            //点击分页，获取新闻列表
//            var nnn=1;
//            $(".right nav").on('click','li',function () {
//                var cla=$(this).attr("class");
//                var num=1;
//                if(cla=="pre"){
//                    if(nnn==1){
//                        return false;
//                    }else {
//                        num=nnn-1;
//                    }
//                }else if(cla=="nex"){
//                    if(nnn==3){
//                        return false;
//                    }else {
//                        num=nnn+1;
//                    }
//                }else {
//                    num=parseInt($(this).find("a").html());
//                    if(num==nnn){
//                        return false;
//                    }
//                }
//                $(".right nav ul li a").css({"background-color":"#fff","color":"#23527c"});
//                $(".right nav ul li:eq("+num+") a").css({"background-color":"#2c6ffc","color":"white"});
//                $.ajax({
//                    url:'/admin/getpage',
//                    type:'post',
//                    data:{num:num},
//                    success:function (data) {
//                        nnn=parseInt(num);
//                        $("tbody").empty();
//                        $.each(data,function (index,element) {
//                            getnews(element);
//                        })
//                    },
//                    error:function (err) {
//                        console.log(err);
//                    }
//                })
//                return false;
//            })



            var getId="";
            var con=true;
            //编辑
            $("tbody").on("click",".btn1",function () {
                var num=$(this).parent().siblings(".col1").html();
                $(this).parent().parent().addClass("wait");
                $.ajax({
                    url:'/admin/change',
                    type:'post',
                    data:{num:num},
                    success:function (data) {
                        init();//初始化
                        getId=data.id;
                        document.querySelector("#left_title").value=data.title;
                        document.querySelector("#left_date").value=data.date.split("T")[0];
                        document.querySelector("#left_content").value=data.content;
                        document.querySelector("#left_url").value=data.imurl;
                        document.querySelector("#left_conurl").value=data.conimg;
                        document.querySelector("#left_type").value=data.type;
                        document.querySelector("#left_source").value=data.source;
                    },
                    error:function (err) {
                        console.log(err);
                    }
                })
            })
            //删除
            $("tbody").on("click",".btn2",function () {
                if(confirm("是否真的删除")){
//                    $(this).parent().parent().remove();
                    var tr= $(this).parent().parent();
                    var num=$(this).parent().siblings(".col1").html();
                    $.ajax({
                        url:'/admin/del',
                        type:'post',
                        data:{num:num},
                        success:function (data) {
                            if(data.status=='ok'){
                                $(tr).remove();
                                alert(data.message);
                            }
                        },
                        error:function (err) {
                            console.log(err);
                        }
                    })
                }
            })
            //表单失去焦点验证
            $(".left input,.left-con").blur(function () {
                var nei=$(this).val();
                if(nei==""){
                    $(this).parent().addClass("has-error");
                }else {
                    $(this).parent().removeClass("has-error")
                }
            })
            //提交
            $(".btn3").click(function () {
                if($("#left_title").val()==""){
                    $("#left_title").parent().addClass("has-error");
                    con=false;
                }
                if($("#left_content").val()==""){
                    $("#left_content").parent().addClass("has-error");
                    con=false;
                }
                if($("#left_url").val()==""){
                    $("#left_url").parent().addClass("has-error");
                    con=false;
                }
                if($("#left_conurl").val()==""){
                    $("#left_conurl").parent().addClass("has-error");
                    con=false;
                }
                if($("#left_source").val()==""){
                    $("#left_source").parent().addClass("has-error");
                    con=false;
                }
                if(con){
                    var getTitle=$("#left_title").val();
                    var getDate=$("#left_date").val();
                    var getContent=$("#left_content").val();
                    var getUrl=$("#left_url").val();
                    var getConurl=$("#left_conurl").val();
                    var getType=$("#left_type").val();
                    var getSource=$("#left_source").val();
                    if(getId==""){ //如果id为空，为创建
                        $.ajax({
                            url:'/admin/create',
                            type:'post',
                            data:{title:getTitle,date:getDate,content:getContent,imgurl:getUrl,conurl:getConurl,type:getType,source:getSource},
                            success:function (data) {
                                //成功后重新初始化，加载新闻列表
                                init()
                                $("tbody").empty();
                                $(".right nav ul .ye").parent().remove();
                                $.each(data.list,function (index,element) {
                                    getnews(element);
                                })
                                var n=data.n;
                                for(var i=n;i>0;i--){
                                    $(".pre").after($("<li><a href='#' class='ye'>"+i+"</a></li>"));
                                }
                            },
                            error:function (err) {
                                console.log(err);
                            }
                        })
                    }else {
                        //如果id不为空，为修改
                        $.ajax({
                            url:'/admin/update',
                            type:'post',
                            data:{getId:getId,title:getTitle,date:getDate,content:getContent,imgurl:getUrl,conurl:getConurl,type:getType,source:getSource},
                            success:function (data) {
                                if(data.status=="ok"){
                                    //成功够初始化，修改列表指定新闻
                                    init()
                                    getId=""; //ID初始化
                                    $(".wait .col2").html(getTitle);
                                    $(".wait .col3").html(getDate);
                                    $(".wait").removeClass("wait");
                                }
                            },
                            error:function (err) {
                                console.log(err);
                            }
                        })
                    }

                }
            })




        })

        //动态创建标签，新闻列表函数
        function getnews(ele) {
            var num=ele.id;
            var title=ele.title;
            var date=ele.date.split("T")[0];
            var tr=$("<tr></tr>");
            var td=$("<td class='col1'>"+num+"</td>");
            td.appendTo(tr);
            td=$("<td class='col2'>"+title+"</td>");
            td.appendTo(tr);
            td=$("<td class='col3'>"+date+"</td>")
            td.appendTo(tr);
            td=$('<td class="col4"><button type="button" class="btn btn-warning btn1">编辑</button> <button type="button" class="btn btn-danger btn2">删除</button></td>');
            td.appendTo(tr);
            tr.appendTo($("tbody"));
        }
        //初始化函数
        function init() {
            var date=new Date();
            var dat= date.getFullYear()+"-"+changeNum(date.getMonth()+1)+"-"+changeNum(date.getDate());
            $("#left_title").val("");
            $("#left_date").val(dat);
            $("#left_content").val("");
            $("#left_url").val("");
            $("#left_conurl").val("");
            $("#left_type").val("精选");
            $("#left_source").val("");
        }
        function changeNum(e) {
            if(e<10){
                e="0"+e;
            }else {
                e=e;
            }
            return e;
        }

    </script>
</body>
</html>